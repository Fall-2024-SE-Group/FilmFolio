{% extends 'shared/layout.html' %}

{% block maincontent %}
<div class="container" style="margin-top: 60px;">
    <!-- Previous flash messages code remains the same -->
    
    <div class="heading1 text-center mb-4">
        <h2>ðŸŽ¬ Pick a Movie! ðŸŽ¬</h2>
        <h6 class="tipHeader text-muted">âœ¨ Tip: Select up to 5 movies to get a tailored watchlist âœ¨</h6>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h3>Search Movies</h3>
            <div class="input-group mb-3">
                <input class="form-control" type="search" placeholder="Search for a Movie" aria-label="Search" id="movieSearch" />
                <button class="btn btn-primary" id="searchBtn">Search</button>
            </div>
            
            <h3 class="mt-4">Selected Movie(s):</h3>
            <ul class="list-group" id="selectedMovies"></ul>
            
            <button class="btn btn-success mt-3" id="predictBtn">Get Recommendations</button>
        </div>

        <div class="col-md-6">
            <h3>Your Recents:</h3>
            <ul class="list-group" id="recentMovies"></ul>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <h2>Recommended Movies:</h2>
            <ul class="list-group" id="predictedMovies"></ul>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="position-fixed top-50 start-50 translate-middle d-none" id="loader">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
$(document).ready(function() {
    let selectedMovies = [];
    
    // Initialize autocomplete for movie search which will used to return a JSON array of movies 
    $("#movieSearch").autocomplete({
        source: function(request, response) {
        //    Sends an AJAX POST request to the /search endpoint with the search term (request.term).
            $.ajax({
                url: "/search",
                type: "POST",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify({
                    query: request.term
                }),
                success: function(data) {
                    // Transform the data for autocomplete
                    response($.map(data, function(item) {
                        return {
                            label: item.title + (item.release_date ? ` (${new Date(item.release_date).getFullYear()})` : ''),
                            value: item.title,
                            movie: item
                        };
                    }));
                },
                error: function(xhr, status, error) {
                    console.error("Search error:", error);
                    response([]);
                }
            });
        },
        minLength: 2,
        select: function(event, ui) {
            if (selectedMovies.length >= 5) {
                alert("You can only select up to 5 movies");
                return false;
            }
            
            if (!selectedMovies.includes(ui.item.value)) {
                selectedMovies.push(ui.item.value);
                updateSelectedMoviesList();
            }
            
            // Clear the search input after selection
            setTimeout(function() {
                $("#movieSearch").val('');
            }, 0);
            
            return false;
        }
    }).autocomplete("instance")._renderItem = function(ul, item) {
        return $("<li>")
            .append("<div>" + item.label + "</div>")
            .appendTo(ul);
    };

    function updateSelectedMoviesList() {
        const $selectedList = $("#selectedMovies");
        $selectedList.empty();
        
        selectedMovies.forEach(function(title) {
            $("<li>")
                .addClass("list-group-item d-flex justify-content-between align-items-center")
                .append(
                    $("<span>").text(title),
                    $("<button>")
                        .addClass("btn btn-sm btn-danger")
                        .text("Remove")
                        .click(function() {
                            removeMovie(title);
                        })
                )
                .appendTo($selectedList);
        });
    }

    function removeMovie(title) {
        selectedMovies = selectedMovies.filter(m => m !== title);
        updateSelectedMoviesList();
    }

    // Get recommendations button click handler
    $("#predictBtn").click(function() {
        if (selectedMovies.length === 0) {
            alert("Please select at least one movie");
            return;
        }

        $("#loader").removeClass("d-none");

        $.ajax({
            url: "/predict",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                movie_list: selectedMovies
            }),
            success: function(data) {
                const predictions = data;
                displayPredictions(predictions);
            },
            error: function(xhr, status, error) {
                console.error("Prediction error:", error);
                alert("Error getting movie recommendations. Please try again.");
            },
            complete: function() {
                $("#loader").addClass("d-none");
            }
        });
    });

    function displayPredictions(predictions) {
    const $predictedList = $("#predictedMovies");
    $predictedList.empty();

    if (!Array.isArray(predictions)) {
        console.error("Invalid predictions format:", predictions);
        alert("Error: Recommendations are not in the expected format.");
        return;
    }

    predictions.forEach(function(movie) {
        // Create list item for each recommended movie
        const $listItem = $("<li>")
            .addClass("list-group-item d-flex align-items-start");

        // Add movie poster image
        const $poster = $("<img>")
            .attr("src", movie.poster_path)
            .attr("alt", movie.title)
            .addClass("img-thumbnail me-3")
            .css({ width: "50px", height: "75px" });

        // Add movie details
        const $details = $("<div>")
            .append($("<h5>").text(movie.title))
            .append($("<p>").text(movie.genres))
            .append($("<small>").text(`Release Date: ${movie.release_date}`))
            .append($("<p>").text(movie.overview));

        // Combine poster and details into list item
        $listItem.append($poster).append($details);
        $predictedList.append($listItem);
    });
}

    // Load recent movies on page load
    function loadRecentMovies() {
        $("#loader").removeClass("d-none");

        $.ajax({
            url: "/getRecentMovies",
            type: "GET",
            success: function(data) {
                const $recentList = $("#recentMovies");
                $recentList.empty();
                
                data.forEach(function(movie) {
                    $("<li>")
                        .addClass("list-group-item")
                        .text(movie.title)
                        .appendTo($recentList);
                });
            },
            error: function(xhr, status, error) {
                console.error("Error fetching recent movies:", error);
            },
            complete: function() {
                $("#loader").addClass("d-none");
            }
        });
    }


    // Load recent movies when page loads
    loadRecentMovies();
});
</script>

{% endblock %}